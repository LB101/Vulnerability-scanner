<?php
session_start();
error_reporting(0);

// Check if the session variable is set and not empty
if ($_SESSION['sms'] == $_POST['sms']) {
    // User is logged in
    echo 'true';

    include "conndb.php";
    
    // Handle registration form submission
    if ($_SERVER["REQUEST_METHOD"] == "POST") {
        // Retrieve user inputs
        $firstname = mysqli_real_escape_string($conn, $_SESSION['firstname']);
        $lastname = mysqli_real_escape_string($conn, $_SESSION['lastname']);
        $email = mysqli_real_escape_string($conn, $_SESSION['email']);
        $phone = mysqli_real_escape_string($conn, $_SESSION['phone']);
        $password = password_hash($_SESSION['password'], PASSWORD_DEFAULT); // Hash the password
    
        // Check if the email is already in use
        $checkEmailQuery = "SELECT id FROM users WHERE email = '$email'";
        $result = mysqli_query($conn, $checkEmailQuery);
    
        if (mysqli_num_rows($result) > 0) {
            // Email already in use
            echo "Error: Email is already in use.";
        } else {
            // Insert user data into the database
            $insertQuery = "INSERT INTO users (firstname, lastname, email, phone,password) VALUES ('$firstname', '$lastname', '$email',  '$phone','$password')";
    
            if (mysqli_query($conn, $insertQuery)) {
                header("Location: success.php?mes=Registration successful User data stored in the database");
            } else {
                echo "Error: " . $insertQuery . "<br>" . mysqli_error($conn);
            }
        }
    
        // Free the result set
        mysqli_free_result($result);
    }
    
    // Close the database connection
    mysqli_close($conn);
    


} else {
    // User is not logged in
    echo 'falsesms';
}
?>
