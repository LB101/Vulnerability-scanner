<?php
session_start(); // Start the session


    include "conndb.php";

    $email = mysqli_real_escape_string($conn, $_POST['email']);
   
    // Check if the email is already in use
    $checkEmailQuery = "SELECT id FROM users WHERE email = '$email'";
    $result = mysqli_query($conn, $checkEmailQuery);

    if (mysqli_num_rows($result) > 0) {
        // Email already in use
        echo "Error: Email is already in use.";
        // Close the database connection
        mysqli_free_result($result);
        mysqli_close($conn);
        exit("Script execution stopped because the condition is true.");
    } 

    // Free the result set
    mysqli_free_result($result);

// Close the database connection
mysqli_close($conn);





$_SESSION['firstname'] = $_POST['firstname'];
$_SESSION['lastname'] = $_POST['lastname'];
$_SESSION['email'] = $_POST['email'];
$_SESSION['phone'] = $_POST['phone'];
$_SESSION['password'] = $_POST['password'];

$phone = "+" . $_POST['phone'];

// Generate random 4-digit code
$randomCode = str_pad(rand(0, 9999), 4, '0', STR_PAD_LEFT);
$_SESSION['sms'] = $randomCode;

$text = "Vulnerability Scanner: Your one time passcode is " . $randomCode;

$apiKey = 'KEY0183A35D1B31B171BD78EEB8369C7C2C_qb0q4m7QwIiPrL4R7KIiix';
$url = 'https://api.telnyx.com/v2/messages';
$data = json_encode([
    'from' => '+447418620546',
    'to' => $phone,
    'text' => $text
]);
$options = [
    'http' => [
        'method' => 'POST',
        'header' => implode("\r\n", [
            'Content-Type: application/json',
            'Authorization: Bearer ' . $apiKey
        ]),
        'content' => $data
    ]
];
$response = file_get_contents($url, false, stream_context_create($options));

//uncomment this for testing eg no more credit on account
echo $response;

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Modem Website</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="icon" type="image/x-icon" href="logo.svg">
    <style>
        body {
            font-family: 'Roboto', sans-serif;

            margin: 0;
            padding: 0;
            background-color: #f2f2f2;
            color: #f2f2f2;
        }

        

        nav {
           
            padding: 10px;
            text-align: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 14px 16px;
            display: inline-block;
        }

        nav a:hover {
            
            color: rgb(255, 251, 0);
        }

        section {
            padding: 20px;
        }

        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 10px;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        body {
            /* Set background image */
            background-image: url('background.png');
            
            /* Set background size to cover the entire viewport */
            background-size: cover;

            /* Set background repeat to no-repeat */
            background-repeat: no-repeat;

            /* Set background position to center center */
            background-position: center center;

            /* Set minimum height to cover the entire viewport */
            min-height: 100vh;

            /* Optional: Add additional styles like background color */
            /* background-color: #f0f0f0; */
            
            /* Optional: Add styles to the content for better readability */
            /* color: #333; */
            /* font-family: Arial, sans-serif; */
            /* other styles... */
        }

        .login {

    background-color: #3498db; /* Blue background color */
    color: white;
    text-decoration: none;
    padding: 12px 18px; /* Adjust padding as needed */
    display: inline-block;
    border-radius: 5px; /* Rounded edges */
    margin-left: 1%;

        }


        .reg{
            border: 2px solid white; 
    border-radius: 10px;
    padding: 10px 16px; /* Adjust padding as needed */
    display: inline-block;

        }


        input[type=text], select {
  width: 100%;
  padding: 12px 20px;
  margin: 8px 0;
  display: inline-block;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}

input[type=submit] {
  width: 100%;
  background-color: #3498db;
  color: white;
  padding: 14px 20px;
  margin: 8px 0;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

input[type=submit]:hover {
    color: rgb(255, 251, 0);
}

div {
  border-radius: 5px;
  /* background-color: #f2f2f2; */
  padding: 20px;
  width: 50%;
  position: absolute;
  
  left: 25%;


}

.inputs{
  width: 100%;
  padding: 12px 20px;
  margin: 8px 0;
  display: inline-block;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}
    </style>
</head>
<body >

    <header>
        
        <nav>
            
            <a href="index.php">Home</a>
            <a href="about.html">About</a>
            <a href="services.html">Services</a>
            <a href="contact.html">Contact</a>
            <a href="login.html" style="float: right" class="login">Login</a>
            <a href="register.html" class="reg" style="float: right">Register</a>
        </nav>
        
    </header>

  

    <div>
        
        <form action="smscheck.php" method="post">

                       
        <label for="sms">Please enter the OTP sent to <?php echo $_POST['phone']; ?></label>

          <input type="text" id="sms" name="sms" placeholder="1234" class="inputs" required>

          <input type="submit" value="Verify">
        </form>
      </div>
    
    <footer>
        &copy; 2024 Your Modem Website. All rights reserved.
    </footer>

</body>
</html>